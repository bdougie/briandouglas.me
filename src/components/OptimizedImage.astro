---
import { Image } from 'astro:assets';
import { getCloudinaryImageUrl, getModernImageFormatsFromPath } from '../utils/cloudinary';

export interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  loading?: 'lazy' | 'eager';
  class?: string;
  format?: 'webp' | 'avif' | 'png' | 'jpg';
  quality?: number;
  useCloudinary?: boolean;
  progressive?: boolean;
  placeholder?: string;
}

const {
  src,
  alt,
  width,
  height,
  loading = 'lazy',
  class: className,
  format = 'webp',
  quality = 85,
  useCloudinary = true,
  progressive = false,
  placeholder
} = Astro.props;

const isGif = src.endsWith('.gif');
const isExternalUrl = src.startsWith('http://') || src.startsWith('https://');
const isGitHubAvatar = src.includes('github.com') || src.includes('avatars.githubusercontent.com');

// Special handling for GitHub avatars - use Cloudinary fetch to optimize them
let optimizedSrc = src;
if (isGitHubAvatar && !useCloudinary) {
  // Use Cloudinary's fetch feature to optimize GitHub avatars
  const encodedUrl = encodeURIComponent(src);
  const transformations = [
    'f_auto',
    'q_auto',
    width ? `w_${width}` : '',
    height ? `h_${height}` : '',
    'c_fill',
    'g_face'
  ].filter(Boolean).join(',');
  
  optimizedSrc = `https://res.cloudinary.com/bdougie/image/fetch/${transformations}/${encodedUrl}`;
} else if (useCloudinary && !isExternalUrl) {
  // Use regular Cloudinary for local images
  optimizedSrc = getCloudinaryImageUrl(src, { width, height, quality, format });
}

// For modern browsers, get WebP and AVIF variants
const modernFormats = (useCloudinary && !isExternalUrl && !isGif)
  ? getModernImageFormatsFromPath(src, { width, height, quality })
  : null;

// Generate modern format URLs for GitHub avatars
const githubAvatarFormats = isGitHubAvatar && !useCloudinary ? {
  webp: optimizedSrc.replace('f_auto', 'f_webp'),
  avif: optimizedSrc.replace('f_auto', 'f_avif'),
  original: optimizedSrc
} : null;

// Generate a unique ID for this image instance
const imageId = `img-${Math.random().toString(36).substr(2, 9)}`;

// Default placeholder for GitHub avatars - a very small base64 encoded blur (10x12 px)
// This is a blurred version that roughly matches the colors of your avatar
const defaultPlaceholder = src.includes('github.com') 
  ? 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAMAAgDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAUH/8QAIBAAAgIBBAMBAAAAAAAAAAAAAQMCBAAFERIhEzFBUf/EABUBAQEAAAAAAAAAAAAAAAAAAAEC/8QAFxEBAQEBAAAAAAAAAAAAAAAAAAECEf/aAAwDAQACEQMRAD8AzGvTfcvXmteOBYsRCRG8VJiJbnv2R9GOq6nqFs11sswyNoiR+S7fBvnLXstXCxTtxhGKluCpCAO+Xsc/cxbqyWJrUhlxsoxMYrIJB67H7lZn//Z'
  : placeholder;

// Build style for progressive wrapper
const wrapperStyle = progressive && defaultPlaceholder
  ? `position: relative; overflow: hidden; background-image: url('${defaultPlaceholder}'); background-size: cover; background-position: center; filter: blur(8px);`
  : '';
---

{progressive && defaultPlaceholder ? (
  <div 
    class={className}
    style={wrapperStyle}
  >
    {isGif ? (
      <img
        id={imageId}
        src={shouldUseCloudinary ? optimizedSrc : src}
        alt={alt}
        width={width}
        height={height}
        loading={loading}
        class="progressive-image"
        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s ease-in-out;"
        decoding="async"
        onload={`this.style.opacity = '1'; this.parentElement.style.filter = 'none';`}
      />
    ) : shouldUseCloudinary && modernFormats ? (
      <picture>
        <source srcset={modernFormats.avif} type="image/avif" />
        <source srcset={modernFormats.webp} type="image/webp" />
        <img
          id={imageId}
          src={modernFormats.original}
          alt={alt}
          width={width}
          height={height}
          loading={loading}
          class={`progressive-image ${className}`}
          style="opacity: 0; transition: opacity 0.5s ease-in-out;"
          decoding="async"
          onload={`this.style.opacity = '1'; this.parentElement.style.filter = 'none';`}
        />
      </picture>
    ) : shouldUseCloudinary ? (
      <img
        id={imageId}
        src={optimizedSrc}
        alt={alt}
        width={width}
        height={height}
        loading={loading}
        class="progressive-image"
        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s ease-in-out;"
        decoding="async"
        onload={`this.style.opacity = '1'; this.parentElement.style.filter = 'none';`}
      />
    ) : (
      <img
        id={imageId}
        src={src}
        alt={alt}
        width={width}
        height={height}
        loading={loading}
        class="progressive-image"
        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s ease-in-out;"
        decoding="async"
        onload={`this.style.opacity = '1'; this.parentElement.style.filter = 'none';`}
      />
    )}
  </div>
) : isGif ? (
  <img
    src={optimizedSrc}
    alt={alt}
    width={width}
    height={height}
    loading={loading}
    class={className}
    decoding="async"
  />
) : githubAvatarFormats ? (
  <picture>
    <source srcset={githubAvatarFormats.avif} type="image/avif" />
    <source srcset={githubAvatarFormats.webp} type="image/webp" />
    <img
      src={githubAvatarFormats.original}
      alt={alt}
      width={width}
      height={height}
      loading={loading}
      class={className}
      decoding="async"
    />
  </picture>
) : modernFormats ? (
  <picture>
    <source srcset={modernFormats.avif} type="image/avif" />
    <source srcset={modernFormats.webp} type="image/webp" />
    <img
      src={modernFormats.original}
      alt={alt}
      width={width}
      height={height}
      loading={loading}
      class={className}
      decoding="async"
    />
  </picture>
) : optimizedSrc !== src ? (
  <img
    src={optimizedSrc}
    alt={alt}
    width={width}
    height={height}
    loading={loading}
    class={className}
    decoding="async"
  />
) : (
  <Image
    src={src}
    alt={alt}
    width={width}
    height={height}
    loading={loading}
    class={className}
    format={format}
    quality={quality}
    densities={[1, 2]}
  />
)}