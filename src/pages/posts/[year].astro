---
import Layout from '../../layouts/Layout.astro';
import { formatDateShort } from '../../utils/dateFormatting';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  const publishedPosts = posts.filter(post => !post.data.draft);
  
  const years = [...new Set(publishedPosts.map(post => 
    new Date(post.data.date).getFullYear().toString()
  ))];
  
  return years.map(year => ({
    params: { year },
    props: { 
      posts: publishedPosts.filter(post => 
        new Date(post.data.date).getFullYear().toString() === year
      ).sort((a, b) => 
        new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
      )
    }
  }));
}

const { year } = Astro.params;
const { posts } = Astro.props;

if (!posts || posts.length === 0) {
  return Astro.redirect('/404');
}

const postsByMonth = posts.reduce((acc, post) => {
  const month = new Date(post.data.date).toLocaleDateString('en-US', { month: 'long' });
  if (!acc[month]) acc[month] = [];
  acc[month].push(post);
  return acc;
}, {} as Record<string, typeof posts>);

const months = Object.keys(postsByMonth);
---

<Layout title={`${year} Posts - bdougie`}>
  <div>
    <div class="mb-8">
      <a href="/posts" class="text-gray-400 hover:text-white transition-colors">‚Üê All Posts</a>
    </div>
    
    <h1 class="text-3xl font-bold text-white mb-12">{year} Posts</h1>
    
    {months.map(month => (
      <div class="mb-12">
        <h2 class="text-lg font-semibold text-gray-500 mb-6">{month} {year}</h2>
        <div class="space-y-4">
          {postsByMonth[month].map((post) => {
            const [y, m, day, ...titleParts] = post.slug.split('-');
            const complexSlug = `${y}/${m}/${day}/${titleParts.join('-')}`;
            
            return (
              <article class="group bg-gray-900/30 border border-gray-800 rounded-lg p-5 hover:bg-gray-900/50 hover:border-gray-700 transition-all">
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <h3 class="text-base font-medium mb-2">
                      <a href={`/posts/${complexSlug}/`} class="text-gray-200 group-hover:text-white transition-colors">
                        {post.data.title}
                      </a>
                    </h3>
                    <p class="text-sm text-gray-400 leading-relaxed line-clamp-2">
                      {post.data.description}
                    </p>
                  </div>
                  <time class="text-xs text-gray-500 ml-4 whitespace-nowrap">
                    {formatDateShort(post.data.date)}
                  </time>
                </div>
              </article>
            );
          })}
        </div>
      </div>
    ))}
  </div>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>