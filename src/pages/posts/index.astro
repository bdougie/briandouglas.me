---
import Layout from '../../layouts/Layout.astro';

const posts = await Astro.glob('./**/*.md');
const sortedPosts = posts
  .filter(post => !post.frontmatter.draft)
  .sort((a, b) => 
    new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime()
  );

// Group posts by year
const postsByYear = sortedPosts.reduce((acc, post) => {
  const year = new Date(post.frontmatter.date).getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof posts>);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));

// Helper function to format date safely
function formatDate(dateStr: string) {
  try {
    // Parse the date string more reliably by treating it as a local date
    const [year, month, day] = dateStr.split('-').map(Number);
    
    // Validate the parsed values
    if (!year || !month || !day || month < 1 || month > 12 || day < 1 || day > 31) {
      return 'Invalid Date';
    }
    
    // Create date using local timezone to avoid UTC offset issues
    const date = new Date(year, month - 1, day);
    
    // Double-check that the date is valid
    if (isNaN(date.getTime()) || 
        date.getFullYear() !== year || 
        date.getMonth() !== month - 1 || 
        date.getDate() !== day) {
      return 'Invalid Date';
    }
    
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    return `${months[date.getMonth()]} ${date.getDate()}`;
  } catch (e) {
    return 'Invalid Date';
  }
}
---

<Layout title="All Posts - bdougie">
  <div>
    <h1 class="text-3xl font-bold text-white mb-12">All Posts</h1>
    
    {years.map(year => (
      <div class="mb-12">
        <h2 class="text-lg font-semibold text-gray-500 mb-6">{year}</h2>
        <div class="space-y-4">
          {postsByYear[Number(year)].map((post) => {
            // Extract the filename and create complex slug
            const filename = post.file.split('/').pop();
            const [y, month, day, ...titleParts] = filename.replace('.md', '').split('-');
            const complexSlug = `${y}/${month}/${day}/${titleParts.join('-')}`;
            
            return (
              <article class="group bg-gray-900/30 border border-gray-800 rounded-lg p-5 hover:bg-gray-900/50 hover:border-gray-700 transition-all">
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <h3 class="text-base font-medium mb-2">
                      <a href={`/posts/${complexSlug}/`} class="text-gray-200 group-hover:text-white transition-colors">
                        {post.frontmatter.title}
                      </a>
                    </h3>
                    <p class="text-sm text-gray-400 leading-relaxed line-clamp-2">
                      {post.frontmatter.description}
                    </p>
                  </div>
                  <time class="text-xs text-gray-500 ml-4 whitespace-nowrap">
                    {formatDate(post.frontmatter.date)}
                  </time>
                </div>
              </article>
            );
          })}
        </div>
      </div>
    ))}
  </div>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
