---
import Layout from '../../../layouts/Layout.astro';
import { formatDateShort } from '../../../utils/dateFormatting';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  const publishedPosts = posts.filter(post => !post.data.draft);
  
  const monthsWithPosts = new Map();
  
  publishedPosts.forEach(post => {
    const date = new Date(post.data.date);
    const year = date.getFullYear().toString();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const key = `${year}-${month}`;
    
    if (!monthsWithPosts.has(key)) {
      monthsWithPosts.set(key, []);
    }
    monthsWithPosts.get(key).push(post);
  });
  
  return Array.from(monthsWithPosts.entries()).map(([key, monthPosts]) => {
    const [year, month] = key.split('-');
    return {
      params: { year, month },
      props: { 
        posts: monthPosts.sort((a, b) => 
          new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
        )
      }
    };
  });
}

const { year, month } = Astro.params;
const { posts } = Astro.props;

if (!posts || posts.length === 0) {
  return Astro.redirect('/404');
}

const monthName = new Date(`${year}-${month}-01`).toLocaleDateString('en-US', { month: 'long' });
---

<Layout title={`${monthName} ${year} Posts - bdougie`}>
  <div>
    <div class="mb-8 flex gap-4">
      <a href="/posts" class="text-gray-400 hover:text-white transition-colors">‚Üê All Posts</a>
      <span class="text-gray-600">/</span>
      <a href={`/posts/${year}`} class="text-gray-400 hover:text-white transition-colors">{year}</a>
    </div>
    
    <h1 class="text-3xl font-bold text-white mb-12">{monthName} {year} Posts</h1>
    
    <div class="space-y-4">
      {posts.map((post) => {
        const [y, m, day, ...titleParts] = post.slug.split('-');
        const complexSlug = `${y}/${m}/${day}/${titleParts.join('-')}`;
        
        return (
          <article class="group bg-gray-900/30 border border-gray-800 rounded-lg p-5 hover:bg-gray-900/50 hover:border-gray-700 transition-all">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="text-base font-medium mb-2">
                  <a href={`/posts/${complexSlug}/`} class="text-gray-200 group-hover:text-white transition-colors">
                    {post.data.title}
                  </a>
                </h3>
                <p class="text-sm text-gray-400 leading-relaxed line-clamp-2">
                  {post.data.description}
                </p>
              </div>
              <time class="text-xs text-gray-500 ml-4 whitespace-nowrap">
                {formatDateShort(post.data.date)}
              </time>
            </div>
          </article>
        );
      })}
    </div>
  </div>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>